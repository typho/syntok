<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Example to represent a .syn file on the web</title>
    <style>
      /* these definitions always make sense */
      .synt-repr > * { white-space: pre; font-family: monospace; }

      /* these color definitions will be generated by Javascript */
      /*
        .synt-repr > .synt-color-0 { color: red }
        .synt-repr > .synt-color-1 { color: green }
        …
      */

      /* if you dare and we assume 'identifier' is a category,
         you can overwrite the enumerated colors this way:   */
      .synt-repr > .synt-cat-identifier { color: blue !important; }
    </style>
    <script>
      // NOTE: please adapt to your needs (assuming you want enumerated and not category-specific colors)
      let lightColorPalette = ['red', 'green', 'blue', 'orange', 'peru', 'purple', 'firebrick'];
      let darkColorPalette = ['red', 'green', 'blue', 'orange', 'purple'];

      function init() {
        defineSynColors();
        if (window.location.hash !== "") {
          console.debug("loading /examples/" + window.location.hash.substr(1) + '.synt');
          fetchSyntFile("/examples/" + window.location.hash.substr(1) + ".synt").then(parseSynFile);
        } else {
          fetchSyntFile("/examples/example01.synt").then(parseSynFile);
        }
      }

      function defineSynColors(use_dark) {
        var sty = document.createElement('style');
        let colorPalette = (use_dark === true) ? darkColorPalette : lightColorPalette;

        sty.type = 'text/css';
        sty.innerHTML = '\n';
        for (let i = 0; i < colorPalette.length; i++) {
          sty.innerHTML += '.synt-repr > .synt-color-' + i + ' { color: ' + colorPalette[i] + '; }\n';
        }
        document.getElementsByTagName('head')[0].appendChild(sty);
      }

      async function fetchSyntFile(url) {
        const response = await fetch(url);
        return response.text();
      }

      function parseSynFile(content) {
        let parser = new DOMParser();
        let dom = parser.parseFromString(content, "text/xml");

        representSynXml(dom.activeElement, document.querySelector('.synt-repr'), false);
      }

      function representSynXml(dom, baseElement, use_dark) {
        let countColors = ((use_dark === true) ? darkColorPalette : lightColorPalette).length;

        for (let item of dom.children) {
          let attr = (e, name) => e.attributes[name].value;
          if (!isValidCategory(attr(item, 'category'))) {
            console.error("Invalid category found: '" + attr(item, 'category') + "'");
            continue;
          }

          var syntaxElement = document.createElement('span');
          syntaxElement.classList.add('synt-item');
          syntaxElement.classList.add('synt-cat-' + attr(item, 'category'));
          syntaxElement.classList.add('synt-color-' + category2colorId(attr(item, 'category'), countColors));
          if (attr(item, 'start') === attr(item, 'end')) {
            syntaxElement.title = attr(item, 'category') + ' at byte offset ' + attr(item, 'start');
          } else {
            syntaxElement.title = attr(item, 'category') + ' at byte offsets ' + attr(item, 'start') + '–' + attr(item, 'end');
          }
          syntaxElement.textContent = item.textContent;

          baseElement.appendChild(syntaxElement);
        }
      }

      // CC BY-SA via https://stackoverflow.com/a/52171480 at 2024-03-28
      function cyrb53(str, seed = 0) {
        let h1 = 0xdeadbeef ^ seed
        let h2 = 0x41c6ce57 ^ seed;
        for (let i = 0, ch; i < str.length; i++) {
          ch = str.charCodeAt(i);
          h1 = Math.imul(h1 ^ ch, 2654435761);
          h2 = Math.imul(h2 ^ ch, 1597334677);
        }
        h1  = Math.imul(h1 ^ (h1 >>> 16), 2246822507);
        h1 ^= Math.imul(h2 ^ (h2 >>> 13), 3266489909);
        h2  = Math.imul(h2 ^ (h2 >>> 16), 2246822507);
        h2 ^= Math.imul(h1 ^ (h1 >>> 13), 3266489909);
      
        return 4294967296 * (2097151 & h2) + (h1 >>> 0);
      }
      
      function category2colorId(category, count) {
        var colorId = 0;
        if (!category)
          return 0;
        return parseInt(cyrb53(category)) % count;
      }

      const categoryRegex = new RegExp("^[_a-zA-Z][_a-zA-Z0-9-]*$");
      function isValidCategory(category) {
        return categoryRegex.exec(category) !== null;
      }
    </script>
  </head>

  <body onload="init()">
    <div class="synt-repr"></div>
  </body>
</html>